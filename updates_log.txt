[2025-09-10 00:00 UTC] Frontend: Improved patient selection in `frontend/src/components/appointments/AppointmentScheduler.tsx` by storing `selectedPatientId` explicitly, clearing it on input change, and using it when booking to prevent failures after selecting a patient. 
[2025-09-10 00:05 UTC] Backend: Relaxed past-date validation in `backend/src/modules/appointments/appointments.service.ts` to compare the slot start time on the given date against `now`, enabling same-day future bookings (fixes booking for patients like Arjun Desai). 
[2025-09-10 00:18 UTC] Backend: Restored `appointments.service.ts` to HEAD and applied minimal edits: (1) validate using slot start time vs now for past-check, (2) filter out past slots on current day in `getAvailableSlots`. Aims to fix booking failure for patient Arjun Desai. 
[2025-09-10 00:22 UTC] Frontend: Enhanced `AppointmentScheduler` to (1) display already booked slots, (2) fetch and map doctor schedule for slot->appointment details, (3) show a dialog with booking/patient details after booking or when clicking a booked slot. 
[2025-09-10 00:28 UTC] Frontend: Improved visual feedback in `AppointmentScheduler` — added selected patient badge with clear button, success banner after booking, and inline loading state on slot buttons while booking. 
[2025-09-10 00:34 UTC] Frontend: AppointmentScheduler now highlights the newly booked slot with a green shade and disables/grays out past slots to prevent clicks. 
[2025-09-10 00:41 UTC] Frontend: Implemented optimistic UI for appointment booking in `AppointmentScheduler` with instant slot state updates, green highlight for the newly booked slot, and stronger gray/disabled styling for past slots. 
[2025-09-10 00:45 UTC] Frontend: Enhanced `AppointmentScheduler` with stronger visual styling — newly booked slots are bright green, past slots are clearly grayed out, booking states show yellow, and success messages auto-clear after 5 seconds with improved design. 
[2025-09-10 00:50 UTC] Frontend: Replaced Tailwind color classes with inline styles in `AppointmentScheduler` to ensure visual styling works correctly with Tailwind v4 — bright green for new bookings, blue for booked slots, gray for past slots. 
[2025-09-10 00:55 UTC] Frontend: Enhanced Calendar view (`AppointmentsCalendar` and `DoctorDayCalendar`) with same visual styling as Slots view — green for newly booked, blue for existing, gray for past slots, patient selection badges, success feedback, and clickable appointment details.
[2025-09-10 01:00 UTC] Frontend: Added room information and appointment type filtering to both Calendar and Slots views — displays room names, visit type badges (OPD/Procedure/Telemedicine), filtering dropdowns, and enhanced appointment details with room and type information.
[2025-09-10 01:15 UTC] Backend: Added `/appointments/rooms` endpoint to fetch all active rooms for appointment booking.
[2025-09-10 01:20 UTC] Frontend: Created comprehensive `AppointmentBookingDialog` component that prompts for appointment type (OPD/Procedure/Telemedicine) and shows real-time room availability with conflict detection. Procedure bookings require room selection, and the dialog shows which rooms are occupied and by whom.
[2025-09-10 01:30 UTC] Backend: Added complete room management system with endpoints for creating, updating, deleting, and fetching rooms (`/appointments/rooms`, `/appointments/rooms/all`, etc.).
[2025-09-10 01:35 UTC] Frontend: Created `RoomsManagement` component with full CRUD operations, room statistics dashboard, and comprehensive room type support (Consultation, Procedure, Operation, Telemedicine, Emergency, Recovery, etc.). Added rooms page to dashboard navigation. 
[2025-09-10 01:40 UTC] Frontend: Implemented comprehensive global search functionality in header — searches across patients, appointments, and users with real-time dropdown results, debounced queries, keyboard navigation, and smart routing to relevant pages.
[2025-09-10 02:15 UTC] Frontend: Enhanced medical visit documentation with role-based form sections (Therapist 20-25%, Nurse 40%, Doctor 100%), integrated camera photo capture, visit numbering system, patient history timeline view, section completion tracking, and progressive form workflow. Backend already supports patient history API and photo uploads.
[2025-09-10 02:30 UTC] Backend: Added room mock data - 2 Consultation Rooms (capacity 2-3), 3 Procedure Rooms (capacity 2-4), 1 Telemedicine Suite (capacity 1). Total 6 rooms created via add-rooms script.
[2025-09-10 02:45 UTC] Frontend: Created comprehensive room calendar view with hourly time slots (8 AM - 8 PM), room occupancy visualization, appointment details display, room type filtering, date navigation, real-time availability status, and integrated room statistics dashboard. Added tabbed interface to rooms page for calendar view and management view.
[2025-09-10 03:00 UTC] Frontend: Fixed RoomCalendar runtime error - backend returns `{ rooms: [...] }` but frontend expected rooms array directly. Added defensive programming with Array.isArray checks and proper response parsing to extract rooms from API response object.
[2025-09-10 03:15 UTC] Frontend: Fixed inventory page showing empty data - backend returns `{ items: [...], pagination: {...} }` but frontend was looking for `response.data`. Updated frontend to extract items from correct response structure and added comprehensive debugging logs.
[2025-09-10 03:30 UTC] Backend: Fixed inventory data not showing due to branch isolation - inventory items were seeded to `branch-seed-1` but user was logged into `test-branch-1`. Moved 79 inventory items to correct branch. API now returns 20 items per page with proper pagination. 
[2025-09-10 07:00 UTC] Frontend: Enhanced patient selection UI to display both Patient ID and Patient Name for better disambiguation - updated visits page dropdown and appointment scheduler search results to show patient ID, phone, and email in structured format with improved visual hierarchy.
[2025-09-10 07:30 UTC] Frontend: Fixed patient name display issue - database uses single `name` field instead of `firstName`/`lastName`. Updated all patient selection components (visits page, appointment scheduler) to use correct `patient.name` field with fallback display logic and added debugging for API response structure verification.

[2025-09-10 08:00 UTC] Database: Added comprehensive patient visit history mock data to seed.ts script - created 5 realistic dermatology visits with detailed complaints, diagnoses, treatments, and follow-up information aligned with existing patient and doctor records.

[2025-09-10 08:15 UTC] Backend: Integrated patient visit history API endpoint `/visits/patient/:patientId/history` into frontend API client with proper authentication headers and query parameter support for pagination.

[2025-09-10 08:30 UTC] Frontend: Implemented PatientHistoryTimeline component with chronological timeline visualization showing visit dates, doctor information, chief complaints, diagnoses, treatments, and notes. Added patient history tab to visits page that's always accessible when a patient is selected, fetching real data from the database API endpoint.

[2025-09-10 08:45 UTC] Frontend: Fixed JSON parsing issue in PatientHistoryTimeline component - API returns some fields (complaints, diagnosis) as already-parsed arrays while others (scribeJson, plan, vitals) are JSON strings. Updated parsing logic to handle both cases correctly to prevent runtime errors.

[2025-09-10 09:15 UTC] Backend: Fixed critical Prisma validation errors in reports service - Payment model doesn't have branchId field, must filter through invoice relationship. Updated payment queries to use `invoice: { branchId }` instead of direct `branchId`. Fixed field name mismatches: used 'reconStatus' instead of 'status' and 'mode' instead of 'method' to match actual Payment model schema. Cleared frontend .next cache and restarted both servers to resolve internal server errors. 

[2025-09-10 09:25 UTC] Backend: Visits history endpoint hardened — coerce `limit` to number, enforce branch scoping via `patient.branchId`; verified 5 seeded visits for Rajesh.

[2025-09-10 09:28 UTC] Frontend: API client now uses standard `get()` for `/visits/patient/:id/history`, ensuring auth headers and proxy; removed ad-hoc fetch.

[2025-09-10 09:32 UTC] Frontend: Fixed React runtime error in PatientHistoryTimeline by rendering `treatment.medications` as a list (supports string or {name,dosage,duration}). 

[2025-09-10 23:20 UTC] Backend: Added protected GET /auth/me returning { id, role, branchId } from JWT; restarted server and verified endpoint.
[2025-09-10 23:20 UTC] Frontend: Visits page now calls /auth/me successfully (fixes "Cannot GET /auth/me" error during initial load). 
[2025-09-11 12:45 UTC] Diagnosis: Rooms calendar view not linked to bookings due to data shape mismatch. `frontend/src/components/rooms/RoomCalendar.tsx` expects room schedule appointments with `startTime`/`endTime` and derives occupancy by hour, but backend `getRoomSchedule` returns only `slot` (e.g., "10:00-10:30"). As a result, `getAppointmentForTimeSlot()` never matches and the calendar shows rooms as available. Also noted minor inconsistencies: visitType labels ('PROCEDURE' vs 'Procedure') and room type strings ('Telemed' vs 'Telemedicine') affecting badges/filters only. Suggested fix: parse `slot` on the frontend or have backend include `startTime`/`endTime` fields; align enums/labels for consistency. 
[2025-09-11 12:52 UTC] Frontend: Connected rooms calendar to bookings by switching to slot-based matching in `frontend/src/components/rooms/RoomCalendar.tsx`. Replaced expected `startTime`/`endTime` with `slot` from backend `getRoomSchedule`, added overlap logic per hour cell, normalized visit type colors (OPD/PROCEDURE/TELEMED), and display slot string. Calendar now correctly shows occupied vs available by room and hour. 
[2025-09-11 13:05 UTC] Frontend: Added visit-linked `PrescriptionBuilder` with drug search, templates, multi-language, validity/refills, and rich item controls; integrated as a new "Prescription" tab in `frontend/src/components/visits/MedicalVisitForm.tsx`. Extended `frontend/src/lib/api.ts` with prescriptions endpoints (create, searchDrugs, templates). 
[2025-09-11 13:12 UTC] Frontend: Fixed `PrescriptionBuilder` rendering by marking it as a client component (`'use client'`), ensuring it mounts inside `MedicalVisitForm` tabs. 
[2025-09-11 13:16 UTC] Frontend: Enabled Prescription tab for ADMIN/OWNER by adding roles with 'all' permissions in `frontend/src/components/visits/MedicalVisitForm.tsx`. 
[2025-09-11 13:28 UTC] Frontend: Enhanced `PrescriptionBuilder` with visit-aware section toggles (header/diagnosis/medications/procedures/counseling/vitals/follow-up/notes/signature), custom sections add/remove, and a print preview dialog with clean A4 layout and print CSS. Auto-seeds fields from visit details. 
[2025-09-11 13:40 UTC] Backend: Added `Drug` model (India-focused) to Prisma schema; implemented POST `/prescriptions/drugs/import` for bulk ingestion and GET `/prescriptions/drugs/autocomplete` for fast UI search; service methods `importDrugs` and `autocompleteDrugs` query the new table. Frontend wired `PrescriptionBuilder` search to `/drugs/autocomplete`. 
[2025-09-11 13:55 UTC] Frontend/Backend: Extended prescription DTO and builder with dermatology fields (site, amount/FTU, day-part, leave-on/wash-off, steroid taper, isotretinoin mg/kg, warnings, food/pulse regimens) and a Procedure Metrics editor; included in payload and print preview. Data posts to backend and persists with prescription record metadata. 
[2025-09-12 17:55 UTC] Frontend: Prescription print preview now renders every selected section with headers and spacing even when empty (shows —). Normalized visit JSON (plan/vitals) for reliable rendering and used visitPlan/visitVitals in preview. Ensures Procedures, Counseling, Vitals, Follow-up, Notes all appear when toggled. 
[2025-09-12 18:05 UTC] Backend: Fixed revenue report queries to use relation filter `invoice: { is: { ... } }` and corrected payment breakdown key (`mode`). Added guard in `findAllPrescriptionTemplates` to return empty results if the Prisma model is missing, preventing 500s. 
[2025-09-12 18:12 UTC] Backend/Frontend: Fixed payments report Prisma invoice relation filter and corrected payment mode mapping; improved frontend ApiClient error handling to gracefully parse non-JSON error bodies (falls back to text) to avoid misleading Internal server error surfaces. 
[2025-09-14 11:52 UTC] Frontend/Backend: Patients filters aligned with seed data — backend gender filter case-insensitive; frontend sends M/F/O and normalizes display/filtering to MALE/FEMALE/OTHER with UNKNOWN fallback. 
[2025-09-14 12:00 UTC] Frontend: Visits setup now uses patient autocomplete with debounce, querying `/patients?search=` and selecting sets `selectedPatientId` (replaces static dropdown). 
[2025-09-14 12:05 UTC] Frontend: New Invoice form now has patient autocomplete (searches `/patients?search=`) and stores selected `patientId`. 
[2025-09-14 12:20 UTC] Frontend: PrescriptionBuilder now shows inline UI feedback for sections that will be auto-included in preview. Chief Complaints, Histories, Family History, Topicals, Post Procedure, Investigations, Procedure Planned, and Procedure Parameters get a subtle green highlight with an “Auto-included in preview” note when their fields are filled. Preview already renders these sections automatically when content is present. 
[2025-09-14 12:55 UTC] Frontend: Prescription print preview supports a background image with configurable top margin. Default set to `/letterhead.png`. Use public assets (frontend/public) and reference as `/letterhead.png`. 
[2025-09-14 13:32 UTC] Backend/Frontend: Scaffolding for 1MG integration added. Backend module `pharmacy/one-mg` with proxy endpoints (search, product, check-inventory, orders, webhooks). Frontend: added "Order via 1MG" entry point in PrescriptionBuilder with a mapping dialog placeholder; API client methods added. 
[2025-09-14 17:40 UTC] Frontend: Set default print preview top margin to 150px in PrescriptionBuilder. 